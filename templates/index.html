<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEG Real-Time Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
        }
        .chart-container {
            width: 80%;
            margin: auto;
            padding-top: 20px;
        }
        .history-container {
            width: 80%;
            margin: auto;
            padding-top: 20px;
            text-align: left;
        }
        .history-container h3 {
            margin-bottom: 10px;
        }
        .history-list {
            list-style-type: none;
            padding: 0;
        }
        .history-list li {
            background-color: #e0e0e0;
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 5px;
        }
        .emotion-dot {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
        }
        .Happiness { background-color: #FFD700; } /* Gold */
        .Sadness { background-color: #1E90FF; }   /* DodgerBlue */
        .Fear { background-color: #FF4500; }      /* OrangeRed */
        .Relaxation { background-color: #32CD32; } /* LimeGreen */
        .Neutral { background-color: #bfbfbf; }    /* Gray */
    </style>
</head>
<body>
    <h1>Real-Time EEG Visualization</h1>
    <div class="chart-container">
        <div id="eeg-chart"></div>
        <h3 id="emotion-label">Emotion: Neutral</h3>
    </div>
    <div class="history-container">
        <h3>Last 5 Emotions:</h3>
        <ul id="emotion-history" class="history-list">
            <!-- Emotion history will be populated here -->
        </ul>
    </div>
    <script>
        const apiUrl = '/eeg-data';
        const bands = ['Delta', 'Theta', 'Alpha', 'Beta', 'Gamma'];
        const colors = ['#636EFA', '#EF553B', '#00CC96', '#AB63FA', '#FFA15A'];

        const layout = {
            title: 'EEG Band Power',
            xaxis: { title: 'Bands' },
            yaxis: { title: 'Power', range: [0, 100] },
        };

        // Initialize chart
        const data = [{
            x: bands,
            y: [0, 0, 0, 0, 0],
            type: 'bar',
            marker: { color: colors },
        }];

        Plotly.newPlot('eeg-chart', data, layout);

        // Initialize emotion history array
        const emotionHistory = [];

        // Function to update emotion history in the DOM
        function updateEmotionHistory(emotion) {
            // Add the latest emotion with timestamp to the beginning of the array
            emotionHistory.unshift({ emotion: emotion, timestamp: Date.now() });
            // Keep only the last 5 emotions
            if (emotionHistory.length > 5) {
                emotionHistory.pop();
            }

            // Update the DOM
            renderEmotionHistory();
        }
        
        // Function to render emotion history
        function renderEmotionHistory() {
            const historyList = document.getElementById('emotion-history');
            historyList.innerHTML = '';

            emotionHistory.forEach((item, index) => {
                const listItem = document.createElement('li');

                // Create a colored dot
                const dot = document.createElement('span');
                dot.classList.add('emotion-dot');
                // Assign class based on emotion
                const emotionClass = item.emotion.replace(/\s+/g, '');
                dot.classList.add(emotionClass);
                listItem.appendChild(dot);

                // Create text node
                const secondsAgo = Math.floor((Date.now() - item.timestamp) / 1000);
                const textNode = document.createTextNode(`${index + 1}. ${item.emotion} (${secondsAgo} seconds ago)`);
                listItem.appendChild(textNode);

                historyList.appendChild(listItem);
            });
        }

        // Fetch and update data
        async function updateChart() {
            try {
                const response = await fetch(apiUrl);
                const { band_power, emotion } = await response.json();

                // Update bar chart
                Plotly.update('eeg-chart', {
                    y: [Object.values(band_power)],
                });

                // Update emotion label
                document.getElementById('emotion-label').innerText = `Emotion: ${emotion}`;

                // Update emotion history
                updateEmotionHistory(emotion);
            } catch (error) {
                console.error('Error fetching EEG data:', error);
            }
        }

        // Function to refresh the time elapsed every second
        function refreshTimeElapsed() {
            renderEmotionHistory();
        }

        // Initial call to populate the chart and history immediately
        updateChart();

        // Refresh data every second
        setInterval(updateChart, 1000);

        // Refresh time elapsed every second
        setInterval(refreshTimeElapsed, 1000);
    </script>
</body>
</html>
